<?php
// $Id$

/**
 * Returns the path to a "dried out version" of the given css file.
 *
 * @param $path
 *    Path to the css file to dry up.
 * @param $basepath
 *    Path from which imports will be relative to.
 * @return 
 *    new path to the dried out version of the provided css, or null if the source css file was not found.
 */
function cssdry_stylesheet($path) {
  require_once('cssdry.inc');

  if (empty($basepath)) {
    $basepath = dirname($path);
  }

  if (file_exists($path)) {
    $dir = file_directory_path() . '/cssdry';
    $dry_file = $dir . '/' . md5(realpath($path)) . '.css';
    if (!file_exists($dry_file) || filemtime($dry_file) < filemtime($path)) {
      if (!file_exists($dir)) {
        mkdir($dir);
      }
      $contents = file_get_contents($path);
      file_put_contents($dry_file, _cssdry($contents, dirname($path)));
    }
    return $dry_file;
  }
}


/**
 * Implements hook_preprocess_page().
 */
function cssdry_preprocess_page(&$vars, $hook) {	
  global $language, $theme;
  
  require_once('cssdry.inc');

  // Grab all the cssdry stylesheets.
  $stylesheets = _cssdry_fetch_theme_stylesheets($theme);
  if (empty($stylesheets)) {
    return;
  }

  // Render the stylesheets to link elements.
  $cssdry_styles = '';

  $query_string = '?'. substr(variable_get('css_js_query_string', '0'), 1, 1);
  $base_path = base_path();
  $output = '';
  
  $types = array();
  
  $timestamp_string = '';
  // Create the $types array for use by drupal_build_css_cache and build an ID representing the current stylesheets state.
  foreach ($stylesheets AS $media => $files) {
  	$types[$media] = array();  	
    foreach ($files AS $file => $path) {
      $types[$media][$path.'/'.$file] = true;
      $timestamp_string .= filemtime($path);
    }
  }
  
  $compressed_file = file_create_path('css').'/dry-'.md5($timestamp_string).".css";
  if (!file_exists($compressed_file)) {
  	$compressed_file = drupal_build_css_cache($types,  'dry-'.md5($timestamp_string).".css");  
  	$compressed_content = file_get_contents($compressed_file);
  	file_put_contents($compressed_file, _cssdry($compressed_content, null));
  }
  
  $cssdry_links .= "<link type=\"text/css\" rel=\"stylesheet\" media=\"$media\" href=\"$base_path$compressed_file$query_string\" />\n";
      
  
  // Append them to $styles and add a $cssdry_styles variable.
  $vars['styles'] .= $vars['cssdry_styles'] = $cssdry_links;
}

/**
 * Returns an associative array from media type to an array of appropriate files.
 *
 * @param $name
 *    The name of the theme.
 * @return
 *    An associative array mapping media types to an array of appropriate css files. 
 */
function _cssdry_fetch_theme_stylesheets($name) {
  $paths = _cssdry_paths_to_basetheme($name);

  $themes = list_themes();

  $stylesheets = array();

  // Start with the base theme and travel up the chain to the active theme.
  foreach ($paths AS $theme_name => $path) {
    // Look at the conditional-stylesheets defined in the theme's .info file.
    if (!empty($themes[$theme_name]->info['cssdry'])) {
      foreach ($themes[$theme_name]->info['cssdry'] AS $media => $files) {
        // Allow the theme to override its base themes' styles.
        foreach ($files AS $file) {
          $stylesheets[$media][$file] = $path;
        }
      }
    }
  }

  return $stylesheets;
}

/**
 * Return paths for the theme and its base themes.
 *
 * @param $theme
 *   The name of the theme.
 * @return
 *   An array of all the theme paths.
 */
function _cssdry_paths_to_basetheme($theme) {
  static $theme_paths;

  if (empty($theme_paths[$theme])) {
    $theme_paths[$theme] = array();
    $themes = list_themes();
    // Grab the paths from the base theme.
    if (!empty($themes[$theme]->base_theme)) {
      $theme_paths[$theme] = _cssdry_paths_to_basetheme($themes[$theme]->base_theme);
    }
    $theme_paths[$theme][$theme] = dirname($themes[$theme]->filename);
  }

  return $theme_paths[$theme];
}